{"version":3,"names":["uniIdCo","common_vendor","er","importObject","db","database","usersTable","collection","hostUserInfo","index","getStorageSync","data","userInfo","hasLogin","Object","keys","length","mutations","updateUserInfo","_arguments","arguments","_this","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","data2","_id","uniIdCo2","res","realNameRes","wrap","_callee$","_context","prev","next","undefined","where","update","then","e","result","updated","showToast","title","icon","duration","setUserInfo","getCurrentUserInfo","uid","cover","customUI","field","get","sent","getRealNameInfo","_objectSpread2","realNameAuth","t0","__f__","message","errCode","stop","_ref","assign","store","setStorageSync","logout","_this2","_callee2","_callee2$","_context2","tokenExpired","Date","now","removeStorageSync","$emit","redirectTo","url","concat","pagesJson","uniIdRouter","loginPage","loginBack","_e$uniIdRedirectUrl","uniIdRedirectUrl","delta","pages","getCurrentPages","forEach","page","route","split","fail","err1","switchTab","err2","reLaunch","path","navigateBack","loginSuccess","_e$showToast","_e$toastText","toastText","_e$autoBack","autoBack","_e$uniIdRedirectUrl2","passwordConfirmed","uni_modules_uniIdPages_config","config","setPasswordAfterLogin","loginType","err","reactive"],"sources":["store.js"],"sourcesContent":["import pagesJson from '@/pages.json'\r\nimport config from '@/uni_modules/uni-id-pages/config.js'\r\n\r\nconst uniIdCo = uniCloud.importObject(\"uni-id-co\")\r\nconst db = uniCloud.database();\r\nconst usersTable = db.collection('uni-id-users')\r\n\r\nlet hostUserInfo = uni.getStorageSync('uni-id-pages-userInfo')||{}\r\n\r\nconst data = {\r\n\tuserInfo: hostUserInfo,\r\n\thasLogin: Object.keys(hostUserInfo).length != 0\r\n}\r\n\r\n// 定义 mutations, 修改属性\r\nexport const mutations = {\r\n\t// data不为空，表示传递要更新的值(注意不是覆盖是合并),什么也不传时，直接查库获取更新\r\n\tasync updateUserInfo(data = false) {\r\n\t\tif (data) {\r\n\t\t\tusersTable.where('_id==$env.uid').update(data).then(e => {\r\n\t\t\t\t// console.log(e);\r\n\t\t\t\tif (e.result.updated) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"更新成功\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.setUserInfo(data)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"没有改变\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t} else {\r\n      // 不等待联网查询，立即更新用户_id确保store.userInfo中的_id是最新的\r\n      const _id = uniCloud.getCurrentUserInfo().uid\r\n      this.setUserInfo({_id},{cover:true})\r\n      // 查库获取用户信息，更新store.userInfo\r\n\t\t\tconst uniIdCo = uniCloud.importObject(\"uni-id-co\", {\r\n\t\t\t\tcustomUI: true\r\n\t\t\t})\r\n\t\t\ttry {\r\n\t\t\t\tlet res = await usersTable.where(\"'_id' == $cloudEnv_uid\")\r\n\t\t\t\t\t.field('mobile,nickname,username,email,avatar_file')\r\n\t\t\t\t\t.get()\r\n\r\n\t\t\t\tconst realNameRes = await uniIdCo.getRealNameInfo()\r\n\r\n\t\t\t\t// console.log('fromDbData',res.result.data);\r\n\t\t\t\tthis.setUserInfo({\r\n\t\t\t\t\t...res.result.data[0],\r\n\t\t\t\t\trealNameAuth: realNameRes\r\n\t\t\t\t})\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.setUserInfo({},{cover:true})\r\n\t\t\t\tconsole.error(e.message, e.errCode);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tsetUserInfo(data, {cover}={cover:false}) {\r\n\t\t// console.log('set-userInfo', data);\r\n\t\tlet userInfo = cover?data:Object.assign(store.userInfo,data)\r\n\t\tstore.userInfo = Object.assign({},userInfo)\r\n\t\tstore.hasLogin = Object.keys(store.userInfo).length != 0\r\n\t\t// console.log('store.userInfo', store.userInfo);\r\n\t\tuni.setStorageSync('uni-id-pages-userInfo', store.userInfo)\r\n\t\treturn data\r\n\t},\r\n\tasync logout() {\r\n\t\t// 1. 已经过期就不需要调用服务端的注销接口\t2.即使调用注销接口失败，不能阻塞客户端\r\n\t\tif(uniCloud.getCurrentUserInfo().tokenExpired > Date.now()){\r\n\t\t\ttry{\r\n\t\t\t\tawait uniIdCo.logout()\r\n\t\t\t}catch(e){\r\n\t\t\t\tconsole.error(e);\r\n\t\t\t}\r\n\t\t}\r\n\t\tuni.removeStorageSync('uni_id_token');\r\n\t\tuni.setStorageSync('uni_id_token_expired', 0)\r\n    this.setUserInfo({},{cover:true})\r\n    uni.$emit('uni-id-pages-logout')\r\n\t\tuni.redirectTo({\r\n\t\t\turl: `/${pagesJson.uniIdRouter && pagesJson.uniIdRouter.loginPage ? pagesJson.uniIdRouter.loginPage: 'uni_modules/uni-id-pages/pages/login/login-withoutpwd'}`,\r\n\t\t});\r\n\t},\r\n\tloginBack (e = {}) {\r\n\t\tconst {uniIdRedirectUrl = ''} = e\r\n\t\tlet delta = 0; //判断需要返回几层\r\n\t\tlet pages = getCurrentPages();\r\n\t\t// console.log(pages);\r\n\t\tpages.forEach((page, index) => {\r\n\t\t\tif (pages[pages.length - index - 1].route.split('/')[3] == 'login') {\r\n\t\t\t\tdelta++\r\n\t\t\t}\r\n\t\t})\r\n\t\t// console.log('判断需要返回几层:', delta);\r\n\t\tif (uniIdRedirectUrl) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl,\r\n\t\t\t\tfail: (err1) => {\r\n\t\t\t\t\tuni.switchTab({\r\n\t\t\t\t\t\turl:uniIdRedirectUrl,\r\n\t\t\t\t\t\tfail: (err2) => {\r\n\t\t\t\t\t\t\tconsole.log(err1,err2)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t\t// #ifdef H5\r\n\t\tif (e.loginType == 'weixin') {\r\n\t\t\t// console.log('window.history', window.history);\r\n\t\t\treturn window.history.go(-3)\r\n\t\t}\r\n\t\t// #endif\r\n\r\n\t\tif (delta) {\r\n\t\t\tconst page = pagesJson.pages[0]\r\n\t\t\treturn uni.reLaunch({\r\n\t\t\t\turl: `/${page.path}`\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tuni.navigateBack({\r\n\t\t\tdelta\r\n\t\t})\r\n\t},\r\n\tloginSuccess(e = {}){\r\n\t\tconst {\r\n\t\t\tshowToast = true, toastText = '登录成功', autoBack = true, uniIdRedirectUrl = '', passwordConfirmed\r\n\t\t} = e\r\n\t\t// console.log({toastText,autoBack});\r\n\t\tif (showToast) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: toastText,\r\n\t\t\t\ticon: 'none',\r\n\t\t\t\tduration: 3000\r\n\t\t\t});\r\n\t\t}\r\n    // 异步调用（更新用户信息）防止获取头像等操作阻塞页面返回\r\n\t\tthis.updateUserInfo()\r\n\r\n\t\tuni.$emit('uni-id-pages-login-success')\r\n\r\n\t\tif (config.setPasswordAfterLogin && !passwordConfirmed) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl ? `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${uniIdRedirectUrl}&loginType=${e.loginType}`: `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,\r\n\t\t\t\tfail: (err) => {\r\n\t\t\t\t\tconsole.log(err)\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tif (autoBack) {\r\n\t\t\tthis.loginBack({uniIdRedirectUrl})\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\n// #ifdef VUE2\r\nimport Vue from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nexport const store = Vue.observable(data)\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport {\r\n\treactive\r\n} from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nexport const store = reactive(data)\r\n// #endif\r\n"],"mappings":"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","ignoreList":[]}