{"version":3,"file":"PinnedCard.js","sources":["components/circle/PinnedCard.vue","../../../Software/hbuilder/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RDovMuWkp-iKsS_mr5XkuJrorr7orqEvQ29tcHVzL2NvbXBvbmVudHMvY2lyY2xlL1Bpbm5lZENhcmQudnVl"],"sourcesContent":["<template>\r\n  <view class=\"pinned-card mp-rounded\" @tap=\"handleViewDetail\">\r\n    <view class=\"pinned-indicator\" v-if=\"isPin\">\r\n      <text class=\"iconfont icon-zhiding\"></text>\r\n    </view>\r\n    <view class=\"post-header\" @tap.stop=\"handleViewDetail\">\r\n      <view class=\"post-avatar-bg\">\r\n        <image :src=\"post.avatar || '/static/images/default-avatar.png'\" class=\"post-avatar mp-rounded\"></image>\r\n      </view>\r\n      <view class=\"post-info\">\r\n        <text class=\"post-name\">{{post.name || '匿名用户'}}</text>\r\n        <text class=\"post-meta\">{{post.type || '官方'}} · {{post.time || '刚刚'}}</text>\r\n      </view>\r\n      <view class=\"tag-container\">\r\n        <text class=\"post-tag pin\" v-if=\"isPin\">置顶</text>\r\n        <text class=\"post-tag\" :class=\"getTagClass(post.type)\">{{post.type || '官方'}}</text>\r\n      </view>\r\n    </view>\r\n    <text class=\"post-content\">{{post.content || ''}}</text>\r\n    <view class=\"post-images\" v-if=\"post.images && post.images.length\">\r\n      <image v-for=\"(img, idx) in post.images\" :key=\"idx\" :src=\"img\" mode=\"aspectFill\" class=\"post-image mp-rounded\"\r\n        @tap.stop=\"previewImage(post.images, idx)\"></image>\r\n    </view>\r\n    <view class=\"post-actions\">\r\n      <view class=\"action-item like-btn clickable-mp\" @tap.stop=\"handleLike\">\r\n        <text class=\"action-icon iconfont icon-dianzan\" :class=\"{'liked': isLiked, 'like-animate': post.likeAnimate}\"></text>\r\n        <text class=\"action-text\" :class=\"{'liked': isLiked}\">{{ post.likes || 0 }}</text>\r\n      </view>\r\n      <view class=\"action-item comment-btn clickable-mp\" @tap.stop=\"handleViewDetail\">\r\n        <text class=\"action-icon iconfont icon-icon_comment\"></text>\r\n        <text class=\"action-text\">{{post.comments || 0}}</text>\r\n      </view>\r\n      <view class=\"action-item share-btn clickable-mp\" @tap.stop>\r\n        <text class=\"action-icon iconfont icon-fasong\"></text>\r\n        <text class=\"action-text\">分享</text>\r\n      </view>\r\n      <slot name=\"actions\"></slot>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: 'PinnedCard',\r\n  props: {\r\n    post: {\r\n      type: Object,\r\n      required: true,\r\n      default: () => ({\r\n        avatar: '/static/images/default-avatar.png',\r\n        name: '匿名用户',\r\n        type: '官方',\r\n        time: '刚刚',\r\n        content: '',\r\n        images: [],\r\n        likes: 0,\r\n        comments: 0,\r\n        isLiked: false,\r\n        likeAnimate: false\r\n      })\r\n    },\r\n    isPin: {\r\n      type: Boolean,\r\n      default: true\r\n    },\r\n    hasCustomActions: {\r\n      type: Boolean,\r\n      default: false\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      likeLoading: false\r\n    }\r\n  },\r\n  computed: {\r\n    isLiked() {\r\n      return this.post.isLiked || false;\r\n    }\r\n  },\r\n  async created() {\r\n    // 组件创建时检查用户点赞状态\r\n    await this.checkUserLikeStatus();\r\n  },\r\n  methods: {\r\n    async checkUserLikeStatus() {\r\n      const userInfo = uni.getStorageSync('uni-id-pages-userInfo');\r\n      if (!userInfo || !userInfo._id || !this.post._id) return;\r\n\r\n      try {\r\n        const likeRes = await uniCloud.database().collection('user-likes')\r\n          .where({\r\n            user_id: userInfo._id,\r\n            post_id: this.post._id\r\n          })\r\n          .get();\r\n\r\n        // 更新点赞状态\r\n        this.post.isLiked = likeRes.result.data.length > 0;\r\n      } catch (e) {\r\n        console.error('检查点赞状态失败:', e);\r\n      }\r\n    },\r\n    async handleViewDetail() {\r\n      try {\r\n        // 确保数据已更新\r\n        await this.$nextTick();\r\n        \r\n        // 使用 Promise 包装导航操作\r\n        await new Promise((resolve, reject) => {\r\n          uni.navigateTo({\r\n            url: `/pages/circle/pinned-datail/pinned-datail?id=${this.post._id}`,\r\n            success: resolve,\r\n            fail: (err) => {\r\n              console.error('导航失败:', err);\r\n              // 如果导航失败，尝试使用 redirectTo\r\n              uni.redirectTo({\r\n                url: `/pages/circle/pinned-datail/pinned-datail?id=${this.post._id}`,\r\n                success: resolve,\r\n                fail: reject\r\n              });\r\n            }\r\n          });\r\n        });\r\n      } catch (error) {\r\n        console.error('页面跳转失败:', error);\r\n        uni.showToast({\r\n          title: '页面跳转失败，请重试',\r\n          icon: 'none',\r\n          duration: 2000\r\n        });\r\n      }\r\n    },\r\n    async handleLike() {\r\n      if (this.likeLoading) return;\r\n      this.likeLoading = true;\r\n\r\n      const userInfo = uni.getStorageSync('uni-id-pages-userInfo');\r\n      if (!userInfo || !userInfo._id) {\r\n        uni.showToast({ title: '请先登录', icon: 'none' });\r\n        this.likeLoading = false;\r\n        return;\r\n      }\r\n\r\n      const userId = userInfo._id;\r\n      const postId = this.post._id;\r\n\r\n      try {\r\n        // 添加点赞动画\r\n        this.post.likeAnimate = true;\r\n        setTimeout(() => {\r\n          this.post.likeAnimate = false;\r\n        }, 500);\r\n\r\n        // 先检查是否已点赞\r\n        const likeRes = await uniCloud.database().collection('user-likes')\r\n          .where({\r\n            user_id: userId,\r\n            post_id: postId\r\n          })\r\n          .get();\r\n\r\n        if (likeRes.result.data.length > 0) {\r\n          // 已点赞，执行取消点赞\r\n          const likeId = likeRes.result.data[0]._id;\r\n          await uniCloud.database().collection('user-likes').doc(likeId).remove();\r\n          await uniCloud.database().collection('add-content').doc(postId).update({\r\n            like_count: this.post.likes - 1\r\n          });\r\n          this.post.isLiked = false;\r\n          this.post.likes -= 1;\r\n          uni.showToast({ title: '已取消点赞', icon: 'none' });\r\n        } else {\r\n          // 未点赞，执行点赞\r\n          await uniCloud.database().collection('user-likes').add({\r\n            user_id: userId,\r\n            post_id: postId,\r\n            create_time: Date.now()\r\n          });\r\n          await uniCloud.database().collection('add-content').doc(postId).update({\r\n            like_count: this.post.likes + 1\r\n          });\r\n          this.post.isLiked = true;\r\n          this.post.likes += 1;\r\n          uni.showToast({ title: '已点赞', icon: 'none' });\r\n        }\r\n\r\n        // 触发父组件的更新\r\n        this.$emit('post-updated', this.post);\r\n      } catch (e) {\r\n        console.error('点赞操作失败:', e);\r\n        uni.showToast({ title: '操作失败', icon: 'none' });\r\n      } finally {\r\n        this.likeLoading = false;\r\n      }\r\n    },\r\n    previewImage(images, index) {\r\n      // 预览图片\r\n      uni.previewImage({\r\n        urls: images,\r\n        current: images[index]\r\n      });\r\n    },\r\n    getTagClass(type) {\r\n      const typeMap = {\r\n        '官方': 'official',\r\n        '商家': 'promotion',\r\n        '活动': 'hot'\r\n      };\r\n      return typeMap[type] || 'official';\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n@import '@/styles/variables.scss';\r\n\r\n.pinned-card {\r\n  margin-bottom: $spacing-base;\r\n  padding: $spacing-base;\r\n  background-color: $white;\r\n  border-radius: $border-radius-base;\r\n  box-shadow: $shadow-base;\r\n  transition: all $transition-base;\r\n  position: relative;\r\n  overflow: hidden;\r\n  border-left: 4rpx solid rgba($warning-color, 0.8);\r\n  border: 1rpx solid rgba(0, 0, 0, 0.02);\r\n  \r\n  &:active {\r\n    transform: scale(0.98);\r\n    opacity: 0.95;\r\n  }\r\n}\r\n\r\n.pinned-indicator {\r\n  position: absolute;\r\n  top: -5rpx;\r\n  right: 20rpx;\r\n  color: rgba($warning-color, 0.7);\r\n  font-size: $font-size-lg;\r\n  transform: rotate(45deg);\r\n  opacity: 0.7;\r\n  animation: pinPulse 2s infinite;\r\n}\r\n\r\n.post-header {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 0 0 8rpx 0;\r\n}\r\n\r\n.post-avatar {\r\n  width: 64rpx;\r\n  height: 64rpx;\r\n  border-radius: 50%;\r\n  border: 2rpx solid #e5e7eb;\r\n  box-shadow: 0 2rpx 8rpx rgba(77,124,191,0.08);\r\n  background: #f5f6fa;\r\n  margin-right: 18rpx;\r\n}\r\n\r\n.post-info {\r\n  flex: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n}\r\n\r\n.post-name {\r\n  color: #000000;\r\n  font-size: 30rpx;\r\n  font-weight: 600;\r\n  margin-bottom: 2rpx;\r\n}\r\n\r\n.post-meta {\r\n  color: #b0b6be;\r\n  font-size: 22rpx;\r\n}\r\n\r\n.tag-container {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-left: 12rpx;\r\n}\r\n\r\n.post-tag {\r\n  padding: 2rpx 16rpx;\r\n  border-radius: 12rpx;\r\n  font-size: 22rpx;\r\n  font-weight: 500;\r\n  background: #f2f4f8;\r\n  color: #4D7CBF;\r\n  margin-left: 8rpx;\r\n}\r\n\r\n.post-tag.pin {\r\n  background: #ffe082;\r\n  color: #b47d00;\r\n  margin-left: 0;\r\n}\r\n\r\n.post-content {\r\n  font-size: $font-size-base;\r\n  color: $black;\r\n  margin-bottom: $spacing-sm;\r\n  line-height: $line-height-normal;\r\n}\r\n\r\n.post-images {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  margin: 0 -6rpx $spacing-sm;\r\n  \r\n  .post-image {\r\n    width: calc(33.33% - 12rpx);\r\n    height: 200rpx;\r\n    margin: 6rpx;\r\n    border-radius: $border-radius-sm;\r\n    background-color: $bg-color;\r\n    transition: all $transition-fast;\r\n    \r\n    &:active {\r\n      transform: scale(0.95);\r\n    }\r\n  }\r\n}\r\n\r\n.post-actions {\r\n  display: flex;\r\n  align-items: center;\r\n  border-top: 1rpx solid $extra-light-gray;\r\n  padding-top: $spacing-sm;\r\n  \r\n  .action-item {\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    margin-right: $spacing-lg;\r\n    padding: 6rpx 16rpx;\r\n    border-radius: $border-radius-lg;\r\n    transition: all $transition-fast;\r\n    \r\n    .action-icon {\r\n      font-size: $font-size-lg;\r\n      color: $gray;\r\n      margin-right: 8rpx;\r\n      transition: all 0.3s ease;\r\n      \r\n      &.liked {\r\n        color: $error-color;\r\n      }\r\n      \r\n      &.like-animate {\r\n        animation: likeAnimation 0.5s ease;\r\n      }\r\n    }\r\n    \r\n    .action-text {\r\n      font-size: $font-size-sm;\r\n      color: $gray;\r\n      transition: color 0.3s ease;\r\n      \r\n      &.liked {\r\n        color: $error-color;\r\n      }\r\n    }\r\n    \r\n    &:active {\r\n      background-color: $bg-color-hover;\r\n      transform: scale(0.95);\r\n    }\r\n  }\r\n  \r\n  .like-btn {\r\n    &:active .action-icon {\r\n      color: $error-color;\r\n      transform: scale(1.2);\r\n    }\r\n  }\r\n  \r\n  .comment-btn {\r\n    &:active .action-icon {\r\n      color: $primary-color;\r\n      transform: scale(1.2);\r\n    }\r\n  }\r\n  \r\n  .share-btn {\r\n    &:active .action-icon {\r\n      color: $success-color;\r\n      transform: scale(1.2);\r\n    }\r\n  }\r\n}\r\n\r\n.view-detail {\r\n  margin-left: auto;\r\n  color: $primary-color;\r\n  font-size: $font-size-sm;\r\n  padding: 6rpx 16rpx;\r\n  border-radius: $border-radius-lg;\r\n  background-color: $primary-color-light;\r\n  display: flex;\r\n  align-items: center;\r\n  \r\n  &:active {\r\n    opacity: 0.8;\r\n    transform: scale(0.95);\r\n  }\r\n}\r\n\r\n.button-group {\r\n  display: flex;\r\n  margin-left: auto;\r\n  \r\n  .detail-btn {\r\n    padding: 8rpx $spacing-lg;\r\n    background-color: $primary-color-light;\r\n    color: $primary-color;\r\n    border-radius: $border-radius-lg;\r\n    font-size: $font-size-sm;\r\n    margin-right: $spacing-xs;\r\n    border: none;\r\n    display: flex;\r\n    align-items: center;\r\n    \r\n    &:active {\r\n      background-color: rgba(22, 93, 255, 0.2);\r\n      transform: scale(0.95);\r\n    }\r\n  }\r\n  \r\n  .action-btn {\r\n    padding: 8rpx $spacing-lg;\r\n    background-color: $primary-color;\r\n    color: $white;\r\n    border-radius: $border-radius-lg;\r\n    font-size: $font-size-sm;\r\n    border: none;\r\n    display: flex;\r\n    align-items: center;\r\n    \r\n    &:active {\r\n      background-color: $primary-color-dark;\r\n      transform: scale(0.95);\r\n    }\r\n  }\r\n}\r\n\r\n@keyframes pinPulse {\r\n  0% {\r\n    transform: rotate(45deg) scale(1);\r\n  }\r\n  50% {\r\n    transform: rotate(45deg) scale(1.2);\r\n  }\r\n  100% {\r\n    transform: rotate(45deg) scale(1);\r\n  }\r\n}\r\n\r\n@keyframes likeAnimation {\r\n  0% { transform: scale(1); }\r\n  50% { transform: scale(1.4); }\r\n  100% { transform: scale(1); }\r\n}\r\n</style> ","import Component from 'D:/2大花/毕业设计/Compus/components/circle/PinnedCard.vue'\nwx.createComponent(Component)"],"names":["uni","uniCloud"],"mappings":"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"}